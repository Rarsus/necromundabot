#!/usr/bin/env node

/**
 * Vulnerability Baseline Synchronizer
 *
 * This script keeps VULNERABILITY-ACCEPTANCE-LOG.md in sync with audit-baseline.json
 * Run this whenever audit-baseline.json is updated to regenerate the log.
 *
 * Usage:
 *   npm run sync:vulnerabilities
 *   node scripts/sync-vulnerability-baseline.js
 */

const fs = require('fs');
const path = require('path');

const BASELINE_FILE = path.join(__dirname, '..', '.github', 'audit-baseline.json');
const LOG_FILE = path.join(__dirname, '..', '.github', 'VULNERABILITY-ACCEPTANCE-LOG.md');

/**
 * Calculate days remaining until date
 */
function daysRemaining(expiresDate) {
  const now = new Date();
  const expires = new Date(expiresDate);
  const diff = expires - now;
  const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
  return days;
}

/**
 * Format date for markdown
 */
function formatDate(dateStr) {
  const date = new Date(dateStr);
  return date.toISOString().split('T')[0];
}

/**
 * Generate markdown table row for vulnerability
 */
function generateVulnRow(vuln) {
  const expires = formatDate(vuln.expiresDate);
  const days = daysRemaining(vuln.expiresDate);
  const critical = vuln.critical ? 'üî¥ CRITICAL' : '';

  return `| ${vuln.cve} | ${vuln.package} | ${vuln.severity} | ${expires} | ${days} | ${critical} |`;
}

/**
 * Generate vulnerability section
 */
function generateVulnSection(vuln, index) {
  const expires = formatDate(vuln.expiresDate);
  const days = daysRemaining(vuln.expiresDate);
  const critical = vuln.critical ? 'üî¥ **CRITICAL EXEMPTION**' : '';
  const reviewed = formatDate(vuln.reviewDate || vuln.acceptedDate);

  let section = `#### ${index}. ${vuln.cve} - ${vuln.package}

${critical}

| Property | Value |
|----------|-------|
| **CVE** | ${vuln.cve} |
| **Package** | ${vuln.package} |
| **Severity** | ${vuln.severity} |
| **Status** | ‚úÖ ACCEPTED |
| **Type** | ${vuln.type} |
| **Description** | ${vuln.description} |
| **Reason** | ${vuln.reason} |
| **Accepted By** | ${vuln.acceptedBy} |
| **Accepted Date** | ${formatDate(vuln.acceptedDate)} |
| **Exemption Expires** | ${expires} |
| **Days Remaining** | **${days}** |
| **Next Review** | ${reviewed} |
| **Risk Level** | ${vuln.riskLevel} |
| **Affected Packages** | ${vuln.affected.join(', ')} |
| **Fix Available** | Yes - ${vuln.fixVersion || vuln.fixOption2 || 'pending'} |
| **Fix Effort** | ${vuln.fixEffort} |
| **Breaking Changes** | ${vuln.fixIsBreaking ? 'Yes' : 'No'} |
`;

  if (vuln.notes) {
    section += `| **Notes** | ${vuln.notes} |\n`;
  }

  if (vuln.linkedTo) {
    section += `| **Linked To** | ${vuln.linkedTo} |\n`;
  }

  section += `\n`;
  return section;
}

/**
 * Generate the complete markdown log
 */
function generateMarkdown(baseline) {
  let markdown = `# Vulnerability Acceptance Log

**Purpose**: Track all accepted vulnerabilities with explicit exemption periods and re-evaluation dates.

**Source of Truth**: [.github/audit-baseline.json](./audit-baseline.json) (run \`npm run sync:vulnerabilities\` to regenerate this file)

**Last Updated**: ${formatDate(baseline.lastUpdated)}

**Last Generated**: ${new Date().toISOString()}

---

## Summary

| Metric | Value |
|--------|-------|
| **Total Accepted** | ${baseline.totalVulnerabilities} |
| **HIGH Severity** | ${baseline.vulnerabilities.filter((v) => v.severity === 'HIGH').length} |
| **MODERATE Severity** | ${baseline.vulnerabilities.filter((v) => v.severity === 'MODERATE').length} |
| **Critical Exemptions** | ${baseline.vulnerabilities.filter((v) => v.critical).length} |
| **Next Review** | ${formatDate(baseline.nextReviewDate)} |
| **Critical Expires** | ${formatDate(baseline.criticalExemptionExpires)} |

---

## Exemption Expiration Schedule

| CVE | Package | Severity | Expires | Days | Status |
|-----|---------|----------|---------|------|--------|
`;

  // Sort by expiration date
  const sorted = [...baseline.vulnerabilities].sort((a, b) => new Date(a.expiresDate) - new Date(b.expiresDate));

  sorted.forEach((vuln) => {
    markdown += generateVulnRow(vuln) + '\n';
  });

  markdown += `\n---\n\n## Current Accepted Vulnerabilities (${baseline.totalVulnerabilities} Total)\n\n`;

  // Group by severity
  const high = baseline.vulnerabilities.filter((v) => v.severity === 'HIGH');
  const moderate = baseline.vulnerabilities.filter((v) => v.severity === 'MODERATE');

  if (high.length > 0) {
    markdown += `### HIGH Severity (${high.length} vulnerabilities)\n\n`;
    high.forEach((vuln, idx) => {
      markdown += generateVulnSection(vuln, idx + 1);
    });
  }

  if (moderate.length > 0) {
    markdown += `### MODERATE Severity (${moderate.length} vulnerabilities)\n\n`;
    moderate.forEach((vuln, idx) => {
      markdown += generateVulnSection(vuln, high.length + idx + 1);
    });
  }

  // Remediation schedule
  markdown += `---\n\n## Remediation Schedule\n\n`;

  const byDate = baseline.vulnerabilities
    .filter((v) => !v.linkedTo)
    .sort((a, b) => new Date(a.expiresDate) - new Date(b.expiresDate));

  byDate.forEach((vuln) => {
    const days = daysRemaining(vuln.expiresDate);
    const daysStr = days <= 30 ? `üî¥ ${days}` : `üü° ${days}`;
    markdown += `- **${formatDate(vuln.expiresDate)}** (${daysStr} days): ${vuln.cve} - Upgrade to ${vuln.fixVersion || vuln.fixOption2}\n`;
  });

  // When exemptions are no longer valid
  markdown += `\n---\n\n## When Exemptions Are NO LONGER Valid\n\n**If ANY of these conditions occur, exemptions are REVOKED:**\n\n`;
  markdown += `1. ‚ùå **Vulnerability is exploited in the wild**\n`;
  markdown += `   - Immediate action required\n`;
  markdown += `   - Exemption suspended\n`;
  markdown += `   - Emergency upgrade planned\n\n`;
  markdown += `2. ‚ùå **Feature becomes enabled/used**\n`;
  markdown += `   - Example: If dashboard goes to production with RSC\n`;
  markdown += `   - Exemption automatically expires\n`;
  markdown += `   - Must upgrade before activation\n\n`;
  markdown += `3. ‚ùå **Dependency is used in new context**\n`;
  markdown += `   - Example: If tar is used at runtime\n`;
  markdown += `   - Exemption void\n`;
  markdown += `   - Must fix immediately\n\n`;
  markdown += `4. ‚ùå **Re-evaluation date passes without renewal**\n`;
  markdown += `   - Exemption expires automatically\n`;
  markdown += `   - Workflow fails until resolved\n`;
  markdown += `   - Blocks all CI/CD\n`;
  markdown += `5. ‚ùå **Baseline expiration date reached**\n`;
  markdown += `   - All exemptions expire on baseline.expiresAt date\n`;
  markdown += `   - Baseline must be renewed or all exemptions revoked\n\n`;

  // Related resources
  markdown += `---\n\n## Related Resources\n\n`;
  markdown += `- [VULNERABILITY-ACCEPTANCE-STRATEGY.md](.github/VULNERABILITY-ACCEPTANCE-STRATEGY.md) - Acceptance policy & philosophy\n`;
  markdown += `- [audit-baseline.json](.github/audit-baseline.json) - Machine-readable source of truth\n`;
  markdown += `- [security.yml](.github/workflows/security.yml) - Workflow that checks against baseline\n`;
  markdown += `- [compare-audit-against-baseline.sh](./scripts/compare-audit-against-baseline.sh) - Validation script\n\n`;

  markdown += `---\n\n`;
  markdown += `**Auto-Generated From**: [.github/audit-baseline.json](.github/audit-baseline.json)\n\n`;
  markdown += `**Last Generated**: ${new Date().toISOString()}\n\n`;
  markdown += `**To Regenerate**: \`npm run sync:vulnerabilities\`\n`;

  return markdown;
}

/**
 * Main function
 */
function main() {
  try {
    // Read baseline
    console.log(`üìñ Reading ${BASELINE_FILE}...`);
    const baselineContent = fs.readFileSync(BASELINE_FILE, 'utf8');
    const baseline = JSON.parse(baselineContent);

    // Generate markdown
    console.log(`üìù Generating markdown from ${baseline.totalVulnerabilities} vulnerabilities...`);
    const markdown = generateMarkdown(baseline);

    // Write log
    console.log(`‚úçÔ∏è  Writing to ${LOG_FILE}...`);
    fs.writeFileSync(LOG_FILE, markdown, 'utf8');

    console.log(`‚úÖ Successfully synced vulnerability baseline!`);
    console.log(`üìä Summary:`);
    console.log(`   - Total vulnerabilities: ${baseline.totalVulnerabilities}`);
    console.log(`   - HIGH severity: ${baseline.vulnerabilities.filter((v) => v.severity === 'HIGH').length}`);
    console.log(`   - MODERATE severity: ${baseline.vulnerabilities.filter((v) => v.severity === 'MODERATE').length}`);
    console.log(`   - Critical exemptions: ${baseline.vulnerabilities.filter((v) => v.critical).length}`);
    console.log(`   - Next review: ${baseline.nextReviewDate}`);
    console.log(`   - Critical expires: ${baseline.criticalExemptionExpires}`);
    console.log(``);
    console.log(`üìù Log file updated: ${LOG_FILE}`);
  } catch (error) {
    console.error(`‚ùå Error syncing vulnerability baseline:`, error.message);
    process.exit(1);
  }
}

// Run main
main();
