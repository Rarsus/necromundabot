name: ðŸš€ Release & Versioning (Workspace-Independent)

on:
  push:
    branches:
      - main
      - develop

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  packages: write
  actions: write
  checks: write
  pull-requests: write

jobs:
  # ============================================================================
  # STEP 1: Run full test suite
  # ============================================================================
  run-tests:
    name: ðŸ§ª Run Full Test Suite
    uses: ./.github/workflows/testing.yml
    permissions:
      contents: read
      pull-requests: write
      checks: write

  # ============================================================================
  # STEP 2: Pre-release security check (runs in parallel with tests)
  # ============================================================================
  pre-release-check:
    name: ðŸ”’ Pre-Release Security Check
    uses: ./.github/workflows/reusable-audit-check.yml
    permissions:
      contents: read
    with:
      fail-on-critical: true
      fail-on-baseline-exceeded: true
      check-baseline: true

  # ============================================================================
  # STEP 3: Analyze workspace changes and determine version bumps
  # ============================================================================
  analyze-workspace-changes:
    name: ðŸ“Š Analyze Workspace Changes
    runs-on: ubuntu-latest
    needs: [run-tests, pre-release-check]
    if: needs.run-tests.result == 'success' && needs.pre-release-check.result == 'success'
    outputs:
      root-version: ${{ steps.analyze.outputs.root-version }}
      utils-bump: ${{ steps.analyze.outputs.utils-bump }}
      core-bump: ${{ steps.analyze.outputs.core-bump }}
      commands-bump: ${{ steps.analyze.outputs.commands-bump }}
      dashboard-bump: ${{ steps.analyze.outputs.dashboard-bump }}
      has-changes: ${{ steps.analyze.outputs.has-changes }}
    
    steps:
      - name: ðŸ“¥ Checkout repository with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: ðŸ“š Install dependencies
        run: npm ci --workspaces

      - name: ðŸ·ï¸ Get latest release tag
        id: get-tag
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LATEST_TAG" ]; then
            FIRST_COMMIT=$(git rev-list --max-parents=0 HEAD)
            COMMIT_RANGE="$FIRST_COMMIT..HEAD"
            echo "tag=initial" >> $GITHUB_OUTPUT
            echo "range=${COMMIT_RANGE}" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No previous release found, analyzing all commits"
          else
            COMMIT_RANGE="$LATEST_TAG..HEAD"
            echo "tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
            echo "range=${COMMIT_RANGE}" >> $GITHUB_OUTPUT
            echo "ðŸ·ï¸ Analyzing changes since $LATEST_TAG"
          fi

      - name: ðŸ” Analyze workspace changes using new system
        id: analyze
        run: |
          echo "ðŸ“Š Running workspace-independent version analysis..."
          echo ""
          
          # Run analysis script that now uses workspace-independent detection
          node scripts/analyze-version-impact.js "${{ steps.get-tag.outputs.tag }}" > analysis_output.txt 2>&1
          
          cat analysis_output.txt
          
          # Parse output (script outputs structured data we can extract)
          # Extract version bumps for each workspace
          ANALYSIS=$(cat analysis_output.txt)
          
          # Initialize all bumps to none
          UTILS_BUMP="none"
          CORE_BUMP="none"
          COMMANDS_BUMP="none"
          DASHBOARD_BUMP="none"
          HAS_CHANGES="false"
          
          # Extract bump levels (simplified parsing - script should output JSON for robustness)
          if echo "$ANALYSIS" | grep -q "necrobot-utils.*MAJOR"; then
            UTILS_BUMP="major"
            HAS_CHANGES="true"
          elif echo "$ANALYSIS" | grep -q "necrobot-utils.*MINOR"; then
            UTILS_BUMP="minor"
            HAS_CHANGES="true"
          elif echo "$ANALYSIS" | grep -q "necrobot-utils.*PATCH"; then
            UTILS_BUMP="patch"
            HAS_CHANGES="true"
          fi
          
          if echo "$ANALYSIS" | grep -q "necrobot-core.*MAJOR"; then
            CORE_BUMP="major"
            HAS_CHANGES="true"
          elif echo "$ANALYSIS" | grep -q "necrobot-core.*MINOR"; then
            CORE_BUMP="minor"
            HAS_CHANGES="true"
          elif echo "$ANALYSIS" | grep -q "necrobot-core.*PATCH"; then
            CORE_BUMP="patch"
            HAS_CHANGES="true"
          fi
          
          if echo "$ANALYSIS" | grep -q "necrobot-commands.*MAJOR"; then
            COMMANDS_BUMP="major"
            HAS_CHANGES="true"
          elif echo "$ANALYSIS" | grep -q "necrobot-commands.*MINOR"; then
            COMMANDS_BUMP="minor"
            HAS_CHANGES="true"
          elif echo "$ANALYSIS" | grep -q "necrobot-commands.*PATCH"; then
            COMMANDS_BUMP="patch"
            HAS_CHANGES="true"
          fi
          
          if echo "$ANALYSIS" | grep -q "necrobot-dashboard.*MAJOR"; then
            DASHBOARD_BUMP="major"
            HAS_CHANGES="true"
          elif echo "$ANALYSIS" | grep -q "necrobot-dashboard.*MINOR"; then
            DASHBOARD_BUMP="minor"
            HAS_CHANGES="true"
          elif echo "$ANALYSIS" | grep -q "necrobot-dashboard.*PATCH"; then
            DASHBOARD_BUMP="patch"
            HAS_CHANGES="true"
          fi
          
          # Extract or calculate root version
          ROOT_VERSION=$(echo "$ANALYSIS" | grep "Root Version Bump:" | head -1 | sed 's/.*â†’ //' | cut -d' ' -f1 || jq -r '.version' package.json)
          
          # Output for next jobs
          echo "utils-bump=${UTILS_BUMP}" >> $GITHUB_OUTPUT
          echo "core-bump=${CORE_BUMP}" >> $GITHUB_OUTPUT
          echo "commands-bump=${COMMANDS_BUMP}" >> $GITHUB_OUTPUT
          echo "dashboard-bump=${DASHBOARD_BUMP}" >> $GITHUB_OUTPUT
          echo "root-version=${ROOT_VERSION}" >> $GITHUB_OUTPUT
          echo "has-changes=${HAS_CHANGES}" >> $GITHUB_OUTPUT
          
          echo ""
          echo "âœ… Analysis complete:"
          echo "  â€¢ necrobot-utils: $UTILS_BUMP"
          echo "  â€¢ necrobot-core: $CORE_BUMP"
          echo "  â€¢ necrobot-commands: $COMMANDS_BUMP"
          echo "  â€¢ necrobot-dashboard: $DASHBOARD_BUMP"
          echo "  â€¢ Root version: $ROOT_VERSION"

  # ============================================================================
  # STEP 4: Apply workspace version bumps
  # ============================================================================
  apply-version-bumps:
    name: ðŸ”„ Apply Version Bumps
    runs-on: ubuntu-latest
    needs: [analyze-workspace-changes]
    if: needs.analyze-workspace-changes.outputs.has-changes == 'true'
    outputs:
      version: ${{ steps.bump.outputs.version }}
    
    steps:
      - name: ðŸ“¥ Checkout repository with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: ðŸ“š Install dependencies
        run: npm ci --workspaces

      - name: ðŸ”„ Bump workspace versions
        id: bump
        run: |
          # Get the tag or initial commit
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LATEST_TAG" ]; then
            FIRST_COMMIT=$(git rev-list --max-parents=0 HEAD)
            COMMIT_RANGE="$FIRST_COMMIT..HEAD"
          else
            COMMIT_RANGE="$LATEST_TAG..HEAD"
          fi
          
          echo "ðŸ“ Applying bumps for range: $COMMIT_RANGE"
          
          # Use sync-package-versions to apply workspace-independent bumps
          node scripts/sync-package-versions.js "$COMMIT_RANGE"
          
          # Get new version
          NEW_VERSION=$(jq -r '.version' package.json)
          echo "version=${NEW_VERSION}" >> $GITHUB_OUTPUT
          echo "âœ… Versions bumped to v${NEW_VERSION}"

      - name: âœ… Verify version updates
        run: |
          echo "ðŸ“‹ Updated versions:"
          echo "  Root: $(jq -r '.version' package.json)"
          echo "  Utils: $(jq -r '.version' repos/necrobot-utils/package.json)"
          echo "  Core: $(jq -r '.version' repos/necrobot-core/package.json)"
          echo "  Commands: $(jq -r '.version' repos/necrobot-commands/package.json)"
          echo "  Dashboard: $(jq -r '.version' repos/necrobot-dashboard/package.json)"

      - name: ðŸ“ Commit version changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add -A
          git commit -m "chore(versioning): Bump workspace versions to v${{ steps.bump.outputs.version }}" --no-verify || echo "âš ï¸ No changes to commit"
          
          # Push directly (won't trigger another release workflow because of when conditions)
          git push origin ${{ github.ref_name }} || echo "âš ï¸ Push failed (might already be up to date)"

      - name: ðŸ·ï¸ Create git tag
        run: |
          VERSION=${{ steps.bump.outputs.version }}
          git tag "v${VERSION}" || echo "âš ï¸ Tag already exists"
          git push origin "v${VERSION}" || true

  # ============================================================================
  # STEP 5: Publish packages (uses optimize parallel for dashboard)
  # ============================================================================
  trigger-publishing:
    name: ðŸ“¤ Trigger Package Publishing
    runs-on: ubuntu-latest
    needs: [apply-version-bumps]
    if: needs.apply-version-bumps.result == 'success'
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: â–¶ï¸ Trigger publish-packages workflow
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'publish-packages.yml',
              ref: context.ref
            });
            console.log('âœ… Triggered publish-packages workflow');

  # ============================================================================
  # RELEASE SUMMARY
  # ============================================================================
  release-summary:
    name: ðŸ“Š Release Summary
    runs-on: ubuntu-latest
    needs: [analyze-workspace-changes, apply-version-bumps]
    if: always()
    
    steps:
      - name: ðŸ“Š Create release summary
        run: |
          echo "## ðŸš€ Release & Versioning Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Workspace Version Bumps" >> $GITHUB_STEP_SUMMARY
          echo "- **necrobot-utils**: ${{ needs.analyze-workspace-changes.outputs.utils-bump }}" >> $GITHUB_STEP_SUMMARY
          echo "- **necrobot-core**: ${{ needs.analyze-workspace-changes.outputs.core-bump }}" >> $GITHUB_STEP_SUMMARY
          echo "- **necrobot-commands**: ${{ needs.analyze-workspace-changes.outputs.commands-bump }}" >> $GITHUB_STEP_SUMMARY
          echo "- **necrobot-dashboard**: ${{ needs.analyze-workspace-changes.outputs.dashboard-bump }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Root Version" >> $GITHUB_STEP_SUMMARY
          echo "- **New Version**: v${{ needs.analyze-workspace-changes.outputs.root-version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Dependency-Aware Propagation" >> $GITHUB_STEP_SUMMARY
          echo "Changes are automatically propagated to dependent workspaces:" >> $GITHUB_STEP_SUMMARY
          echo "- `necrobot-utils` â†’ `necrobot-core`, `necrobot-commands`, `necrobot-dashboard`" >> $GITHUB_STEP_SUMMARY
          echo "- `necrobot-core` â†’ `necrobot-commands`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Tests passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Security checks passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Versions bumped" >> $GITHUB_STEP_SUMMARY
          echo "- â³ Publishing packages (parallel Docker builds)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ðŸŸ¢ Release workflow complete" >> $GITHUB_STEP_SUMMARY
