name: PR Checks - Fast Validation

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches: [main]

# Prevent duplicate runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  lint-and-format:
    name: 'Lint & Format Check'
    uses: ./.github/workflows/reusable-lint-format.yml
    permissions:
      contents: read
      pull-requests: write
    if: ${{ github.event_name == 'push' || github.event.pull_request.draft == false }}

  pr-validation:
    name: 'PR Structure Validation'
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: üéØ Validate PR title
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const validPrefixes = [
              'feat:', 'feature:',
              'fix:', 'bugfix:',
              'docs:',
              'style:',
              'refactor:',
              'perf:', 'performance:',
              'test:', 'testing:',
              'chore:',
              'ci:', 'cd:',
              'revert:',
              'merge:'
            ];

            // Strip common WIP/Draft prefixes before validation
            let titleToValidate = pr.title;
            const wipPrefixes = [
              /^\[WIP\]\s*/i,
              /^\[Draft\]\s*/i,
              /^\[DO NOT MERGE\]\s*/i,
              /^WIP:\s*/i,
              /^Draft:\s*/i
            ];
            
            for (const prefix of wipPrefixes) {
              titleToValidate = titleToValidate.replace(prefix, '');
            }

            const hasValidPrefix = validPrefixes.some(prefix =>
              titleToValidate.toLowerCase().startsWith(prefix)
            );

            if (!hasValidPrefix) {
              core.setFailed(
                `‚ùå PR title must start with one of: ${validPrefixes.join(', ')}\n` +
                `Current: "${pr.title}"\n` +
                `After stripping WIP/Draft prefixes: "${titleToValidate}"\n` +
                `Tip: WIP/Draft prefixes like [WIP], [Draft], WIP:, Draft: are automatically stripped`
              );
            } else {
              if (titleToValidate !== pr.title) {
                core.notice(`‚úÖ PR title format valid after stripping WIP prefix: "${titleToValidate}"`);
              } else {
                core.notice(`‚úÖ PR title format valid: "${pr.title}"`);
              }
            }

      - name: üìè Check PR size
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const additions = pr.additions || 0;
            const deletions = pr.deletions || 0;
            const total = additions + deletions;

            let message = '';

            if (total > 1000) {
              message += `‚ö†Ô∏è **Large PR (${total} lines changed)**\n`;
              message += '- Consider breaking into smaller PRs\n';
              message += '- Ensures better review quality\n';
              message += '- Speeds up CI/CD pipeline\n\n';
            } else if (total > 500) {
              message += `‚ÑπÔ∏è **Medium PR (${total} lines changed)**\n\n`;
            } else {
              message += `‚úÖ PR size good (${total} lines)\n\n`;
            }

            core.notice(message);

      - name: üîÑ Check for breaking changes
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = (pr.body || '').toLowerCase();

            const hasBreakingLabel = pr.labels?.some(l =>
              l.name.toLowerCase().includes('breaking')
            );

            const mentionedBreaking = body.includes('breaking change') ||
                                      body.includes('breaking changes') ||
                                      body.includes('‚ö†Ô∏è');

            if (pr.title.toLowerCase().startsWith('fix:') ||
                pr.title.toLowerCase().startsWith('feature:') ||
                pr.title.toLowerCase().startsWith('feat:')) {

              if ((hasBreakingLabel || mentionedBreaking) &&
                  !body.includes('migration guide') &&
                  !body.includes('migration path')) {
                core.warning(
                  '‚ö†Ô∏è Breaking changes detected but no migration guide found.\n' +
                  'Please include migration instructions in PR description.'
                );
              }
            }

  dependency-check:
    name: 'Dependency Audit with Baseline'
    uses: ./.github/workflows/reusable-audit-check.yml
    permissions:
      contents: read
    with:
      fail-on-critical: true
      fail-on-baseline-exceeded: true
      check-baseline: true

  summary:
    name: 'Check Summary'
    runs-on: ubuntu-latest
    needs: [lint-and-format, pr-validation, dependency-check]
    if: always()

    steps:
      - name: üéØ Set status
        uses: actions/github-script@v7
        with:
          script: |
            const lintResult = '${{ needs.lint-and-format.result }}';
            const prResult = '${{ needs.pr-validation.result }}';
            const depResult = '${{ needs.dependency-check.result }}';
            
            // Treat 'skipped' as passing since jobs can be intentionally skipped (e.g., draft PRs)
            const lintPassed = lintResult === 'success' || lintResult === 'skipped';
            const prPassed = prResult !== 'failure';
            const depPassed = depResult === 'success' || depResult === 'skipped';

            let message = '## ‚úÖ PR Checks Summary\n\n';
            message += `${lintPassed ? '‚úÖ' : '‚ùå'} Code Quality`;
            if (lintResult === 'skipped') {
              message += ' (skipped - draft PR)\n';
            } else {
              message += '\n';
            }
            message += `${prPassed ? '‚úÖ' : '‚ö†Ô∏è'} PR Structure\n`;
            message += `${depPassed ? '‚úÖ' : '‚ùå'} Dependencies`;
            if (depResult === 'skipped') {
              message += ' (skipped)\n';
            } else {
              message += '\n';
            }

            if (!lintPassed || !depPassed) {
              core.setFailed('PR checks did not pass');
            } else {
              core.notice('All PR checks passed!');
            }

