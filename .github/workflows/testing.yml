name: Testing - Unit & Integration

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  unit-tests:
    name: 'Unit Tests (Node 22.x)'
    uses: ./.github/workflows/reusable-tests.yml
    permissions:
      contents: read
      checks: write
      pull-requests: write
    with:
      test-type: 'unit'
      coverage-enabled: true

  integration-tests:
    name: 'Integration Tests'
    uses: ./.github/workflows/reusable-tests.yml
    permissions:
      contents: read
      checks: write
      pull-requests: write
    needs: [unit-tests]
    if: always() && needs.unit-tests.result != 'failure'
    with:
      test-type: 'integration'
      coverage-enabled: true

  test-summary:
    name: 'Test Summary'
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: always()

    steps:
      - name: ğŸ“‹ Create test summary
        uses: actions/github-script@v7
        with:
          script: |
            const unitResult = '${{ needs.unit-tests.result }}';
            const integrationResult = '${{ needs.integration-tests.result }}';

            const allPassed = [unitResult, integrationResult]
              .every(r => r === 'success' || r === 'skipped');

            let summary = '## ğŸ§ª Test Execution Summary\n\n';
            summary += `${unitResult === 'success' ? 'âœ…' : 'âŒ'} Unit Tests (Node 22)\n`;
            summary += `${integrationResult === 'success' ? 'âœ…' : 'âŒ'} Integration Tests\n`;

            if (allPassed) {
              core.notice('âœ… All tests passed!');
            } else {
              core.setFailed('Some tests failed');
            }

      - name: âŒ Fail workflow if tests failed
        if: |
          needs.unit-tests.result == 'failure' ||
          needs.integration-tests.result == 'failure'
        run: exit 1

