name: ğŸ”™ Rollback Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to rollback (e.g., v1.0.0)'
        required: true
      reason:
        description: 'Reason for rollback'
        required: true
        default: 'Critical issues detected'

permissions:
  contents: write
  packages: write

jobs:
  validate-rollback:
    name: âœ… Validate Rollback Request
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: ğŸ” Verify tag exists
        run: |
          if ! git tag -l | grep -E "(^v?${{ inputs.version }}$|^${{ inputs.version }}$)"; then
            echo "âŒ Tag not found: ${{ inputs.version }}"
            exit 1
          fi
          echo "âœ… Tag verified: ${{ inputs.version }}"

      - name: ğŸ“Š Generate rollback impact report
        run: |
          echo "## Rollback Impact Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Reason**: ${{ inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          COMMITS=$(git rev-list --count ${{ inputs.version }}..HEAD)
          echo "**Commits since release**: $COMMITS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "âš ï¸ This rollback will:" >> $GITHUB_STEP_SUMMARY
          echo "- Revert $COMMITS commit(s)" >> $GITHUB_STEP_SUMMARY
          echo "- Delete tag: ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- Attempt to unpublish packages" >> $GITHUB_STEP_SUMMARY
          echo "- Document the rollback" >> $GITHUB_STEP_SUMMARY

  execute-rollback:
    name: ğŸ”„ Execute Rollback
    runs-on: ubuntu-latest
    needs: validate-rollback
    environment:
      name: production-rollback
      required: true
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”§ Configure Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: ğŸ”™ Run rollback script
        run: |
          ROLLBACK_VERSION="${{ inputs.version }}" \
          ROLLBACK_REASON="${{ inputs.reason }}" \
          ROLLBACK_CONFIRM=true \
          node scripts/rollback-release.js "${{ inputs.version }}" "${{ inputs.reason }}" --confirm

      - name: ğŸ“¤ Push rollback commit
        run: |
          git push origin main || echo "âš ï¸ Push may have failed - check manually"
          # Also push deletion of tag
          git push origin :refs/tags/${{ inputs.version }} 2>/dev/null || echo "âš ï¸ Tag deletion may have failed"

      - name: ğŸ“ Document rollback
        run: |
          echo "## âœ… Rollback Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Reason**: ${{ inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp**: $(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Actions Taken" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Tag deleted" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Revert commit created" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Packages unpublished" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Rollback documented" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Investigate the issues that caused this rollback" >> $GITHUB_STEP_SUMMARY
          echo "2. Create fixes and push new commits" >> $GITHUB_STEP_SUMMARY
          echo "3. Next automatic release will publish corrected version" >> $GITHUB_STEP_SUMMARY
          echo "4. Review [Rollback Log](.github/ROLLBACK-LOG.md)" >> $GITHUB_STEP_SUMMARY

      - name: ğŸš¨ Notify on rollback
        if: always()
        run: |
          echo "âš ï¸ Release rollback executed:"
          echo "   Version: ${{ inputs.version }}"
          echo "   Reason: ${{ inputs.reason }}"
          echo ""
          echo "See workflow run for details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

  verify-rollback:
    name: âœ… Verify Rollback Success
    runs-on: ubuntu-latest
    needs: execute-rollback
    if: always()
    permissions:
      contents: read
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: ğŸ” Verify tag deleted
        run: |
          TAG="${{ inputs.version }}"
          if git tag -l | grep -E "^${TAG}$"; then
            echo "âŒ Tag still exists: $TAG"
            exit 1
          fi
          echo "âœ… Tag successfully deleted: $TAG"

      - name: ğŸ“‹ List recent commits
        run: |
          echo "## Recent Commits" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          git log --oneline -10 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“Š Final status
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                  âœ… ROLLBACK VERIFIED                      â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Rollback for version ${{ inputs.version }} completed successfully."
          echo ""
          echo "ğŸ“ Rollback Log:"
          [ -f .github/ROLLBACK-LOG.md ] && head -20 .github/ROLLBACK-LOG.md || echo "No rollback log yet"
