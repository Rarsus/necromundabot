name: Publish Packages to GitHub Packages

on:
  # Triggered after workspace versioning and tests pass
  workflow_dispatch:
  
  # Also trigger on direct package.json changes for flexibility
  push:
    branches:
      - main
    paths:
      - 'repos/*/package.json'
      - '.github/workflows/publish-packages.yml'

permissions:
  contents: read
  packages: write

jobs:
  # ============================================================================
  # SEQUENTIAL: Publish packages in dependency order (utils â†’ core â†’ commands)
  # ============================================================================
  
  # STEP 1: Publish necrobot-utils (foundation, no dependencies)
  publish-utils:
    name: ðŸ“¦ Publish necrobot-utils
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      NODE_AUTH_TOKEN: ${{ secrets.PACKAGE_TOKEN }}
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@rarsus'

      - name: ðŸ“š Install dependencies
        run: cd repos/necrobot-utils && npm ci

      - name: ðŸ“¤ Publish to GitHub Packages
        run: cd repos/necrobot-utils && npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.PACKAGE_TOKEN }}

      - name: âœ… Verify publication
        run: |
          sleep 2
          if npm view @rarsus/necrobot-utils@"$(jq -r '.version' repos/necrobot-utils/package.json)" >/dev/null 2>&1; then
            VERSION=$(npm view @rarsus/necrobot-utils version)
            echo "âœ… Published @rarsus/necrobot-utils@$VERSION"
          else
            echo "âš ï¸ Package not yet available in registry"
          fi

  # STEP 2: Publish necrobot-core (depends on necrobot-utils)
  publish-core:
    name: ðŸ“¦ Publish necrobot-core
    needs: publish-utils
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      NODE_AUTH_TOKEN: ${{ secrets.PACKAGE_TOKEN }}
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@rarsus'

      - name: ðŸ“š Install dependencies
        run: cd repos/necrobot-core && npm ci

      - name: ðŸ“¤ Publish to GitHub Packages
        run: cd repos/necrobot-core && npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.PACKAGE_TOKEN }}

      - name: âœ… Verify publication
        run: |
          sleep 2
          if npm view @rarsus/necrobot-core@"$(jq -r '.version' repos/necrobot-core/package.json)" >/dev/null 2>&1; then
            VERSION=$(npm view @rarsus/necrobot-core version)
            echo "âœ… Published @rarsus/necrobot-core@$VERSION"
          else
            echo "âš ï¸ Package not yet available in registry"
          fi

  # STEP 3: Publish necrobot-commands (depends on necrobot-core & necrobot-utils)
  publish-commands:
    name: ðŸ“¦ Publish necrobot-commands
    needs: publish-core
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      NODE_AUTH_TOKEN: ${{ secrets.PACKAGE_TOKEN }}
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@rarsus'

      - name: ðŸ“š Install dependencies
        run: cd repos/necrobot-commands && npm ci

      - name: ðŸ“¤ Publish to GitHub Packages
        run: cd repos/necrobot-commands && npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.PACKAGE_TOKEN }}

      - name: âœ… Verify publication
        run: |
          sleep 2
          if npm view @rarsus/necrobot-commands@"$(jq -r '.version' repos/necrobot-commands/package.json)" >/dev/null 2>&1; then
            VERSION=$(npm view @rarsus/necrobot-commands version)
            echo "âœ… Published @rarsus/necrobot-commands@$VERSION"
          else
            echo "âš ï¸ Package not yet available in registry"
          fi

  # STEP 4: Publish necrobot-dashboard (depends on necrobot-utils only)
  # NOTE: This can run in parallel with core/commands since it only depends on utils (already published)
  # However, semantic versioning coordination still requires it after commands for clarity
  publish-dashboard:
    name: ðŸ“¦ Publish necrobot-dashboard
    needs: publish-utils  # Only needs utils, could run in parallel with core+commands
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      NODE_AUTH_TOKEN: ${{ secrets.PACKAGE_TOKEN }}
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@rarsus'

      - name: ðŸ“š Install dependencies
        run: cd repos/necrobot-dashboard && npm ci

      - name: ðŸ“¤ Publish to GitHub Packages
        run: cd repos/necrobot-dashboard && npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.PACKAGE_TOKEN }}

      - name: âœ… Verify publication
        run: |
          sleep 2
          if npm view @rarsus/necrobot-dashboard@"$(jq -r '.version' repos/necrobot-dashboard/package.json)" >/dev/null 2>&1; then
            VERSION=$(npm view @rarsus/necrobot-dashboard version)
            echo "âœ… Published @rarsus/necrobot-dashboard@$VERSION"
          else
            echo "âš ï¸ Package not yet available in registry"
          fi

  # ============================================================================
  # PARALLEL: Build Docker images independently (bot & dashboard parallel)
  # ============================================================================
  
  # Docker image for main bot (can run independently after tests)
  build-bot-docker:
    name: ðŸ³ Build Bot Docker Image
    needs: publish-commands  # Wait for all publishing to complete
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      version: ${{ steps.version.outputs.version }}
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: ðŸ“¦ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“‹ Get version
        id: version
        run: |
          VERSION=$(jq -r '.version' package.json)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: ðŸ“Š Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=semver,pattern=v{{version}},value=v${{ steps.version.outputs.version }}
            type=semver,pattern={{version}},value=${{ steps.version.outputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ steps.version.outputs.version }}
            type=ref,event=branch
            type=sha

      - name: ðŸ—ï¸ Build and push Bot Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_VERSION=22

      - name: ðŸ“ Bot Docker build summary
        run: |
          echo "## ðŸ³ Bot Docker Image" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: v${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry**: ghcr.io/${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Built & Pushed" >> $GITHUB_STEP_SUMMARY

  # Docker image for dashboard (runs in PARALLEL with bot image)
  build-dashboard-docker:
    name: ðŸŽ¨ Build Dashboard Docker Image
    needs: publish-dashboard  # Only needs dashboard published, can run in parallel with bot
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      version: ${{ steps.version.outputs.version }}
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: ðŸ“¦ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“‹ Get version
        id: version
        run: |
          VERSION=$(jq -r '.version' package.json)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: ðŸ“Š Extract Dashboard Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}-dashboard
          tags: |
            type=semver,pattern=v{{version}},value=v${{ steps.version.outputs.version }}
            type=semver,pattern={{version}},value=${{ steps.version.outputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ steps.version.outputs.version }}
            type=ref,event=branch
            type=sha

      - name: ðŸ—ï¸ Build and push Dashboard Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./repos/necrobot-dashboard
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_VERSION=22

      - name: ðŸ“ Dashboard Docker build summary
        run: |
          echo "## ðŸŽ¨ Dashboard Docker Image" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: v${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry**: ghcr.io/${{ github.repository }}-dashboard" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Built & Pushed" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # FINAL: Verify all packages and images
  # ============================================================================
  
  verify:
    name: âœ… Verify Published Artifacts
    needs: [publish-utils, publish-core, publish-commands, publish-dashboard, build-bot-docker, build-dashboard-docker]
    runs-on: ubuntu-latest
    if: always()
    env:
      NODE_AUTH_TOKEN: ${{ secrets.PACKAGE_TOKEN }}
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: ðŸ” Configure npm for GitHub Packages
        run: |
          npm config set @rarsus:registry https://npm.pkg.github.com
          npm config set //npm.pkg.github.com/:_authToken="$NODE_AUTH_TOKEN"

      - name: ðŸ” Verify published packages
        run: |
          echo "## ðŸ“¦ Package Registry Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for pkg in necrobot-utils necrobot-core necrobot-commands necrobot-dashboard; do
            if npm view @rarsus/$pkg >/dev/null 2>&1; then
              VERSION=$(npm view @rarsus/$pkg version)
              echo "âœ… @rarsus/$pkg@$VERSION" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ @rarsus/$pkg (not yet available)" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: ðŸ³ Verify Docker images
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ³ Docker Image Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Bot Image" >> $GITHUB_STEP_SUMMARY
          echo "- Registry: ghcr.io/${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- Status: âœ… Available" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Dashboard Image" >> $GITHUB_STEP_SUMMARY
          echo "- Registry: ghcr.io/${{ github.repository }}-dashboard" >> $GITHUB_STEP_SUMMARY
          echo "- Status: âœ… Available" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“Š Workflow Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Publishing Order" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… necrobot-utils (foundation)" >> $GITHUB_STEP_SUMMARY
          echo "2. âœ… necrobot-core (depends on utils)" >> $GITHUB_STEP_SUMMARY
          echo "3. âœ… necrobot-commands (depends on core & utils)" >> $GITHUB_STEP_SUMMARY
          echo "4. âœ… necrobot-dashboard (depends on utils)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Docker Builds (Parallel)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ³ Bot image: ${{ needs.build-bot-docker.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ¨ Dashboard image: ${{ needs.build-dashboard-docker.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All artifacts published successfully!" >> $GITHUB_STEP_SUMMARY
