name: Publish Packages to GitHub Packages

on:
  # Triggered after release workflow completes (creates versions)
  workflow_dispatch:
  # Also trigger on direct package.json changes for flexibility
  push:
    branches:
      - main
    paths:
      - 'repos/*/package.json'
      - '.github/workflows/publish-packages.yml'

permissions:
  contents: read
  packages: write

jobs:
  # ============================================================================
  # DEPENDENCY ORDER: utils â†’ core â†’ commands â†’ dashboard
  # ============================================================================

  # STEP 1: Publish necrobot-utils (foundation, no dependencies)
  publish-utils:
    name: Publish necrobot-utils
    uses: ./.github/workflows/reusable-publish-package.yml
    with:
      package-name: necrobot-utils
      workspace-path: repos/necrobot-utils
      scope: '@rarsus'
    secrets:
      PACKAGE_TOKEN: ${{ secrets.PACKAGE_TOKEN }}

  # STEP 2: Publish necrobot-core (depends on necrobot-utils)
  publish-core:
    name: Publish necrobot-core
    needs: publish-utils
    uses: ./.github/workflows/reusable-publish-package.yml
    with:
      package-name: necrobot-core
      workspace-path: repos/necrobot-core
      scope: '@rarsus'
    secrets:
      PACKAGE_TOKEN: ${{ secrets.PACKAGE_TOKEN }}

  # STEP 3: Publish necrobot-commands (depends on necrobot-core & necrobot-utils)
  publish-commands:
    name: Publish necrobot-commands
    needs: publish-core
    uses: ./.github/workflows/reusable-publish-package.yml
    with:
      package-name: necrobot-commands
      workspace-path: repos/necrobot-commands
      scope: '@rarsus'
    secrets:
      PACKAGE_TOKEN: ${{ secrets.PACKAGE_TOKEN }}

  # STEP 4: Publish necrobot-dashboard (depends on necrobot-utils)
  publish-dashboard:
    name: Publish necrobot-dashboard
    needs: publish-commands
    uses: ./.github/workflows/reusable-publish-package.yml
    with:
      package-name: necrobot-dashboard
      workspace-path: repos/necrobot-dashboard
      scope: '@rarsus'
    secrets:
      PACKAGE_TOKEN: ${{ secrets.PACKAGE_TOKEN }}

  # VERIFY: Confirm all published packages are accessible
  verify:
    name: Verify Published Packages
    needs: [publish-utils, publish-core, publish-commands, publish-dashboard]
    runs-on: ubuntu-latest
    if: always()
    env:
      NODE_AUTH_TOKEN: ${{ secrets.PACKAGE_TOKEN }}
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: ðŸ” Configure npm for GitHub Packages
        run: |
          npm config set @rarsus:registry https://npm.pkg.github.com
          npm config set //npm.pkg.github.com/:_authToken="$NODE_AUTH_TOKEN"

      - name: ðŸ“‹ Verify publication order
        run: |
          echo "========================================"
          echo "ðŸ“‹ Package Publishing Order Verification"
          echo "========================================"
          echo ""
          echo "âœ… STEP 1: necrobot-utils (foundation)"
          echo "âœ… STEP 2: necrobot-core (depends on utils)"
          echo "âœ… STEP 3: necrobot-commands (depends on core & utils)"
          echo "âœ… STEP 4: necrobot-dashboard (depends on utils)"
          echo ""
          echo "This ensures correct dependency resolution"
          echo "========================================"

      - name: ðŸ” Verify published packages
        run: |
          echo ""
          echo "ðŸ” Checking GitHub Packages registry..."
          echo ""

          # Check utils
          if npm view @rarsus/necrobot-utils >/dev/null 2>&1; then
            UTILS_VERSION=$(npm view @rarsus/necrobot-utils version)
            echo "âœ… @rarsus/necrobot-utils@$UTILS_VERSION"
          else
            echo "â³ @rarsus/necrobot-utils (publishing or not yet available)"
          fi

          # Check core
          if npm view @rarsus/necrobot-core >/dev/null 2>&1; then
            CORE_VERSION=$(npm view @rarsus/necrobot-core version)
            echo "âœ… @rarsus/necrobot-core@$CORE_VERSION"
          else
            echo "â³ @rarsus/necrobot-core (publishing or not yet available)"
          fi

          # Check commands
          if npm view @rarsus/necrobot-commands >/dev/null 2>&1; then
            COMMANDS_VERSION=$(npm view @rarsus/necrobot-commands version)
            echo "âœ… @rarsus/necrobot-commands@$COMMANDS_VERSION"
          else
            echo "â³ @rarsus/necrobot-commands (publishing or not yet available)"
          fi

          # Check dashboard
          if npm view @rarsus/necrobot-dashboard >/dev/null 2>&1; then
            DASHBOARD_VERSION=$(npm view @rarsus/necrobot-dashboard version)
            echo "âœ… @rarsus/necrobot-dashboard@$DASHBOARD_VERSION"
          else
            echo "â³ @rarsus/necrobot-dashboard (publishing or not yet available)"
          fi

          echo ""
          echo "âœ… Workflow completed successfully!"

      - name: ðŸ“Š Summary
        if: always()
        run: |
          echo "## ðŸ“¦ Package Publishing Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Published Packages" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… @rarsus/necrobot-utils" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… @rarsus/necrobot-core" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… @rarsus/necrobot-commands" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… @rarsus/necrobot-dashboard" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Publishing Order" >> $GITHUB_STEP_SUMMARY
          echo "1. necrobot-utils (foundation)" >> $GITHUB_STEP_SUMMARY
          echo "2. necrobot-core (depends on utils)" >> $GITHUB_STEP_SUMMARY
          echo "3. necrobot-commands (depends on core & utils)" >> $GITHUB_STEP_SUMMARY
          echo "4. necrobot-dashboard (depends on utils)" >> $GITHUB_STEP_SUMMARY
