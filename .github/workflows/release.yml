name: ðŸš€ Release & Versioning

on:
  push:
    branches:
      - main
      - develop

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  packages: write
  actions: write
  checks: write
  pull-requests: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PARALLEL PHASE 1: Pre-Release Checks (3 parallel jobs)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  # Job 1a: Run full test suite
  run-tests:
    name: ðŸ§ª Run Full Test Suite
    uses: ./.github/workflows/testing.yml
    permissions:
      contents: read
      pull-requests: write
      checks: write

  # Job 1b: Pre-release security check (parallel with tests)
  pre-release-check:
    name: ðŸ”’ Pre-Release Security Check
    uses: ./.github/workflows/reusable-audit-check.yml
    permissions:
      contents: read
    with:
      fail-on-critical: true
      fail-on-baseline-exceeded: true
      check-baseline: true

  # Job 1c: Lint & format validation (parallel with tests & security)
  lint-format-check:
    name: âœ… Code Quality Check
    uses: ./.github/workflows/reusable-lint-format.yml
    with:
      fail-on-error: true
      comment-on-pr: false

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SEQUENTIAL PHASE 2: Version Analysis
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  analyze-workspace-changes:
    name: ðŸ“Š Analyze Workspace Changes
    runs-on: ubuntu-latest
    needs: [run-tests, pre-release-check, lint-format-check]
    if: needs.run-tests.result == 'success' && needs.pre-release-check.result == 'success'
    outputs:
      root-version: ${{ steps.analyze.outputs.root-version }}
      utils-bump: ${{ steps.analyze.outputs.utils-bump }}
      core-bump: ${{ steps.analyze.outputs.core-bump }}
      commands-bump: ${{ steps.analyze.outputs.commands-bump }}
      dashboard-bump: ${{ steps.analyze.outputs.dashboard-bump }}
      has-changes: ${{ steps.analyze.outputs.has-changes }}
    
    steps:
      - name: ðŸ“¥ Checkout repository with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: ðŸ“š Install dependencies
        run: npm ci --workspaces

      - name: ðŸ·ï¸ Get latest release tag
        id: get-tag
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LATEST_TAG" ]; then
            FIRST_COMMIT=$(git rev-list --max-parents=0 HEAD)
            COMMIT_RANGE="$FIRST_COMMIT..HEAD"
            echo "tag=initial" >> $GITHUB_OUTPUT
            echo "range=${COMMIT_RANGE}" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No previous release found, analyzing all commits"
          else
            COMMIT_RANGE="$LATEST_TAG..HEAD"
            echo "tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
            echo "range=${COMMIT_RANGE}" >> $GITHUB_OUTPUT
            echo "ðŸ·ï¸ Analyzing changes since $LATEST_TAG"
          fi

      - name: ðŸ” Analyze workspace changes using new system
        id: analyze
        run: |
          echo "ðŸ“Š Running workspace-independent version analysis..."
          echo ""
          
          # Run analysis script that now uses workspace-independent detection
          # Add error handling to show script output if it fails
          if ! node scripts/analyze-version-impact.js "${{ steps.get-tag.outputs.tag }}" > analysis_output.txt 2>&1; then
            echo "âŒ Analysis script failed"
            echo "=== Script output ==="
            cat analysis_output.txt
            exit 1
          fi
          
          cat analysis_output.txt
          
          # Parse output (script outputs structured data we can extract)
          # Extract version bumps for each workspace
          ANALYSIS=$(cat analysis_output.txt)
          
          # Initialize all bumps to none
          UTILS_BUMP="none"
          CORE_BUMP="none"
          COMMANDS_BUMP="none"
          DASHBOARD_BUMP="none"
          ROOT_BUMP="none"
          HAS_CHANGES="false"
          
          # Extract bump levels from script output
          # Script outputs lines like: necrobot-utils: MAJOR
          UTILS_BUMP=$(echo "$ANALYSIS" | grep "^necrobot-utils:" | awk '{print tolower($NF)}' || echo "none")
          CORE_BUMP=$(echo "$ANALYSIS" | grep "^necrobot-core:" | awk '{print tolower($NF)}' || echo "none")
          COMMANDS_BUMP=$(echo "$ANALYSIS" | grep "^necrobot-commands:" | awk '{print tolower($NF)}' || echo "none")
          DASHBOARD_BUMP=$(echo "$ANALYSIS" | grep "^necrobot-dashboard:" | awk '{print tolower($NF)}' || echo "none")
          ROOT_BUMP=$(echo "$ANALYSIS" | grep "^Root Version Bump:" | awk '{print tolower($NF)}' || echo "none")
          
          # Check if there are any changes (any bump other than 'none')
          if [[ "$UTILS_BUMP" != "none" ]] || [[ "$CORE_BUMP" != "none" ]] || [[ "$COMMANDS_BUMP" != "none" ]] || [[ "$DASHBOARD_BUMP" != "none" ]]; then
            HAS_CHANGES="true"
          fi
          
          # Output for next jobs
          echo "utils-bump=${UTILS_BUMP}" >> $GITHUB_OUTPUT
          echo "core-bump=${CORE_BUMP}" >> $GITHUB_OUTPUT
          echo "commands-bump=${COMMANDS_BUMP}" >> $GITHUB_OUTPUT
          echo "dashboard-bump=${DASHBOARD_BUMP}" >> $GITHUB_OUTPUT
          echo "root-version=${ROOT_BUMP}" >> $GITHUB_OUTPUT
          echo "has-changes=${HAS_CHANGES}" >> $GITHUB_OUTPUT
          
          echo ""
          echo "âœ… Analysis complete:"
          echo "  â€¢ necrobot-utils: $UTILS_BUMP"
          echo "  â€¢ necrobot-core: $CORE_BUMP"
          echo "  â€¢ necrobot-commands: $COMMANDS_BUMP"
          echo "  â€¢ necrobot-dashboard: $DASHBOARD_BUMP"
          echo "  â€¢ Has changes: $HAS_CHANGES"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SEQUENTIAL PHASE 3: Apply Version Bumps & Create Tags
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  apply-version-bumps:
    name: ðŸ”„ Apply Version Bumps
    runs-on: ubuntu-latest
    needs: [analyze-workspace-changes]
    if: needs.analyze-workspace-changes.outputs.has-changes == 'true'
    outputs:
      version: ${{ steps.bump.outputs.version }}
    
    steps:
      - name: ðŸ“¥ Checkout repository with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: ðŸ“š Install dependencies
        run: npm ci --workspaces

      - name: ðŸ”„ Bump workspace versions
        id: bump
        run: |
          # Get the tag or initial commit
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LATEST_TAG" ]; then
            FIRST_COMMIT=$(git rev-list --max-parents=0 HEAD)
            COMMIT_RANGE="$FIRST_COMMIT..HEAD"
          else
            COMMIT_RANGE="$LATEST_TAG..HEAD"
          fi
          
          echo "ðŸ“ Applying bumps for range: $COMMIT_RANGE"
          
          # Use sync-package-versions to apply workspace-independent bumps
          node scripts/sync-package-versions.js "$COMMIT_RANGE"
          
          # Get new version
          NEW_VERSION=$(jq -r '.version' package.json)
          echo "version=${NEW_VERSION}" >> $GITHUB_OUTPUT
          echo "âœ… Versions bumped to v${NEW_VERSION}"

      - name: âœ… Verify version updates
        run: |
          echo "ðŸ“‹ Updated versions:"
          echo "  Root: $(jq -r '.version' package.json)"
          echo "  Utils: $(jq -r '.version' repos/necrobot-utils/package.json)"
          echo "  Core: $(jq -r '.version' repos/necrobot-core/package.json)"
          echo "  Commands: $(jq -r '.version' repos/necrobot-commands/package.json)"
          echo "  Dashboard: $(jq -r '.version' repos/necrobot-dashboard/package.json)"

      - name: ðŸ“ Commit version changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add -A
          git commit -m "chore(versioning): Bump workspace versions to v${{ steps.bump.outputs.version }}" --no-verify || echo "âš ï¸ No changes to commit"
          
          # Push directly (won't trigger another release workflow because of when conditions)
          git push origin ${{ github.ref_name }} || echo "âš ï¸ Push failed (might already be up to date)"

      - name: ðŸ·ï¸ Create git tag
        run: |
          VERSION=${{ steps.bump.outputs.version }}
          git tag "v${VERSION}" || echo "âš ï¸ Tag already exists"
          git push origin "v${VERSION}" || true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PARALLEL PHASE 4: Publishing & Docker Builds (3 parallel jobs)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  # Job 4a: Sequential package publishing (utils â†’ core â†’ commands â†’ dashboard)
  publish-utils:
    name: ðŸ“¦ Publish necrobot-utils
    needs: [apply-version-bumps]
    uses: ./.github/workflows/reusable-publish-package.yml
    with:
      package-name: necrobot-utils
      workspace-path: repos/necrobot-utils
      scope: '@rarsus'
    secrets:
      PACKAGE_TOKEN: ${{ secrets.PACKAGE_TOKEN }}

  publish-core:
    name: ðŸ“¦ Publish necrobot-core
    needs: [publish-utils]
    uses: ./.github/workflows/reusable-publish-package.yml
    with:
      package-name: necrobot-core
      workspace-path: repos/necrobot-core
      scope: '@rarsus'
    secrets:
      PACKAGE_TOKEN: ${{ secrets.PACKAGE_TOKEN }}

  publish-commands:
    name: ðŸ“¦ Publish necrobot-commands
    needs: [publish-core]
    uses: ./.github/workflows/reusable-publish-package.yml
    with:
      package-name: necrobot-commands
      workspace-path: repos/necrobot-commands
      scope: '@rarsus'
    secrets:
      PACKAGE_TOKEN: ${{ secrets.PACKAGE_TOKEN }}

  publish-dashboard:
    name: ðŸ“¦ Publish necrobot-dashboard
    needs: [publish-commands]
    uses: ./.github/workflows/reusable-publish-package.yml
    with:
      package-name: necrobot-dashboard
      workspace-path: repos/necrobot-dashboard
      scope: '@rarsus'
    secrets:
      PACKAGE_TOKEN: ${{ secrets.PACKAGE_TOKEN }}

  # Job 4b: Build bot Docker image (parallel with publishing)
  build-bot-image:
    name: ðŸ³ Build Bot Docker Image
    runs-on: ubuntu-latest
    needs: [apply-version-bumps]
    if: needs.apply-version-bumps.result == 'success'
    permissions:
      contents: read
      packages: write
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      image-tags: ${{ steps.meta.outputs.tags }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: ðŸ“¦ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“‹ Get version
        id: get-version
        run: |
          VERSION=$(jq -r '.version' package.json)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: ðŸ“Š Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=semver,pattern=v{{version}},value=v${{ steps.get-version.outputs.version }}
            type=semver,pattern={{version}},value=${{ steps.get-version.outputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ steps.get-version.outputs.version }}
            type=raw,value=stable,enable={{is_default_branch}}

      - name: ðŸ—ï¸ Build and push bot image
        uses: docker/build-push-action@v5
        with:
          context: .
          target: bot
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Job 4c: Build dashboard Docker image (parallel with bot build & publishing)
  build-dashboard-image:
    name: ðŸŽ¨ Build Dashboard Docker Image
    runs-on: ubuntu-latest
    needs: [apply-version-bumps]
    if: needs.apply-version-bumps.result == 'success'
    permissions:
      contents: read
      packages: write
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      image-tags: ${{ steps.meta.outputs.tags }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: ðŸ“¦ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“‹ Get version
        id: get-version
        run: |
          VERSION=$(jq -r '.version' package.json)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: ðŸ“Š Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}-dashboard
          tags: |
            type=semver,pattern=v{{version}},value=v${{ steps.get-version.outputs.version }}
            type=semver,pattern={{version}},value=${{ steps.get-version.outputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ steps.get-version.outputs.version }}
            type=raw,value=stable,enable={{is_default_branch}}

      - name: ðŸ—ï¸ Build and push dashboard image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          target: dashboard
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # FINAL PHASE: Verification & Summary (runs after all parallel jobs)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  verify-packages:
    name: âœ… Verify Published Packages
    runs-on: ubuntu-latest
    needs: [publish-dashboard]
    if: always()
    env:
      NODE_AUTH_TOKEN: ${{ secrets.PACKAGE_TOKEN }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: ðŸ” Configure npm
        run: |
          npm config set @rarsus:registry https://npm.pkg.github.com
          npm config set //npm.pkg.github.com/:_authToken="$NODE_AUTH_TOKEN"

      - name: ðŸ” Verify packages in registry
        run: |
          echo "## ðŸ“¦ Package Registry Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for pkg in necrobot-utils necrobot-core necrobot-commands necrobot-dashboard; do
            if npm view @rarsus/$pkg >/dev/null 2>&1; then
              VERSION=$(npm view @rarsus/$pkg version)
              echo "âœ… @rarsus/$pkg@$VERSION" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ @rarsus/$pkg (not yet available)" >> $GITHUB_STEP_SUMMARY
            fi
          done

  release-summary:
    name: ðŸ“Š Release Summary
    runs-on: ubuntu-latest
    needs: [analyze-workspace-changes, apply-version-bumps, build-bot-image, build-dashboard-image, verify-packages]
    if: always()

    steps:
      - name: ðŸ“Š Create release summary
        run: |
          echo "## ðŸš€ Release & Versioning Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### âœ… Release Phases Completed" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… Pre-release checks (tests, security, lint)" >> $GITHUB_STEP_SUMMARY
          echo "2. âœ… Workspace analysis (version impact analysis)" >> $GITHUB_STEP_SUMMARY
          echo "3. âœ… Version bumping (workspace-independent)" >> $GITHUB_STEP_SUMMARY
          echo "4. âœ… Publishing (parallel npm packages + Docker images)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“Š Workspace Version Bumps" >> $GITHUB_STEP_SUMMARY
          echo "- **necrobot-utils**: ${{ needs.analyze-workspace-changes.outputs.utils-bump }}" >> $GITHUB_STEP_SUMMARY
          echo "- **necrobot-core**: ${{ needs.analyze-workspace-changes.outputs.core-bump }}" >> $GITHUB_STEP_SUMMARY
          echo "- **necrobot-commands**: ${{ needs.analyze-workspace-changes.outputs.commands-bump }}" >> $GITHUB_STEP_SUMMARY
          echo "- **necrobot-dashboard**: ${{ needs.analyze-workspace-changes.outputs.dashboard-bump }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸŽ¯ Release Version" >> $GITHUB_STEP_SUMMARY
          echo "**v${{ needs.apply-version-bumps.outputs.version }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ³ Docker Images" >> $GITHUB_STEP_SUMMARY
          echo "- **Bot**: ghcr.io/${{ github.repository }}:v${{ needs.build-bot-image.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dashboard**: ghcr.io/${{ github.repository }}-dashboard:v${{ needs.build-dashboard-image.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“ˆ Parallelism Strategy" >> $GITHUB_STEP_SUMMARY
          echo "- Phase 1: 3 parallel pre-release checks (tests, security, lint)" >> $GITHUB_STEP_SUMMARY
          echo "- Phase 2: Sequential version analysis" >> $GITHUB_STEP_SUMMARY
          echo "- Phase 3: Sequential version bumping & tagging" >> $GITHUB_STEP_SUMMARY
          echo "- Phase 4: 3 parallel job groups:" >> $GITHUB_STEP_SUMMARY
          echo "  - Sequential npm package publishing (with dependency order)" >> $GITHUB_STEP_SUMMARY
          echo "  - Parallel bot Docker image build" >> $GITHUB_STEP_SUMMARY
          echo "  - Parallel dashboard Docker image build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**Status**: ðŸŸ¢ Complete" >> $GITHUB_STEP_SUMMARY
