# Vulnerability Acceptance Automation

**Purpose:** Maintain a single source of truth (audit-baseline.json) with automatic synchronization to human-readable documentation (VULNERABILITY-ACCEPTANCE-LOG.md)

**Status:** ‚úÖ Active & Operational

---

## Overview

This system ensures vulnerability acceptance decisions are:

- ‚úÖ Explicitly documented
- ‚úÖ Time-bound with hard expiration dates
- ‚úÖ Automatically synchronized (no manual doc updates)
- ‚úÖ CI-enforceable (fails on expired exemptions)
- ‚úÖ Auditable (shows who approved what and when)

---

## Architecture

### Single Source of Truth: `audit-baseline.json`

**File Location:** `.github/audit-baseline.json`

**Purpose:** Machine-readable authoritative record of all accepted vulnerabilities

**Key Fields:**

```json
{
  "version": "2.0.0",
  "totalVulnerabilities": 13,
  "vulnerabilities": [
    {
      "id": "undici-decompression-1",
      "cve": "GHSA-6hxm-7r2w-pxwj",
      "package": "undici",
      "severity": "HIGH",
      "status": "ACCEPTED",
      "acceptedDate": "2026-01-28",
      "acceptedBy": "Olav",
      "expiresDate": "2026-05-01",
      "fixVersion": "discord.js@15.0.0+",
      "fixEffort": "22-35 hours"
      // ... more fields
    }
  ]
}
```

**When to Edit:** Only when accepting new vulnerabilities or updating exemptions

**Rules:**

1. All accepted vulnerabilities MUST have an expiration date
2. Expiration dates MUST be realistic (not indefinite)
3. CVE identifiers MUST match official CVE/GHSA database
4. Linked vulnerabilities MUST reference each other via `linkedTo` field
5. Critical exemptions MUST have `"critical": true`

### Auto-Generated: `VULNERABILITY-ACCEPTANCE-LOG.md`

**File Location:** `.github/VULNERABILITY-ACCEPTANCE-LOG.md`

**Purpose:** Human-readable documentation generated from audit-baseline.json

**Contents:**

- Detailed vulnerability tables grouped by severity
- Expiration dates with "days remaining" calculation
- Remediation schedules
- "When exemptions are no longer valid" section
- Critical warnings for approaching expiration dates

**When to Edit:** NEVER - This file is auto-generated

**How to Update:** Run `npm run sync:vulnerabilities` to regenerate

---

## Synchronization Process

### Automatic Sync Script

**Script:** `scripts/sync-vulnerability-baseline.js`

**What it does:**

1. Reads `audit-baseline.json`
2. Validates JSON structure and required fields
3. Calculates days remaining until expiration for each vulnerability
4. Generates markdown tables with vulnerabilities grouped by severity
5. Creates remediation schedule with dates
6. Generates "When exemptions are no longer valid" section
7. Writes complete markdown to `VULNERABILITY-ACCEPTANCE-LOG.md`
8. Reports summary statistics

**How to run:**

```bash
# Via npm script
npm run sync:vulnerabilities

# Or directly
node scripts/sync-vulnerability-baseline.js
```

**Output:**

```
üìñ Reading /home/olav/repo/necromundabot/.github/audit-baseline.json...
üìù Generating markdown from 13 vulnerabilities...
‚úçÔ∏è  Writing to /home/olav/repo/necromundabot/.github/VULNERABILITY-ACCEPTANCE-LOG.md...
‚úÖ Successfully synced vulnerability baseline!
üìä Summary:
   - Total vulnerabilities: 13
   - HIGH severity: 5
   - MODERATE severity: 3
   - Critical exemptions: 4
   - Next review: 2026-04-01
   - Critical expires: 2026-05-01
```

---

## Workflow: Adding or Updating Vulnerabilities

### Step 1: Review npm audit

```bash
npm audit --json > audit-report.json
```

Identify new vulnerabilities not in `audit-baseline.json`

### Step 2: Assess Risk

For each vulnerability:

- [ ] Identify source (which package)
- [ ] Understand CVE/GHSA identifier
- [ ] Assess actual risk in your context
- [ ] Identify remediation path and timeline
- [ ] Set realistic expiration date

### Step 3: Update `audit-baseline.json`

Add new vulnerability entry:

```json
{
  "id": "some-vuln-id",
  "cve": "GHSA-xxxx-xxxx-xxxx",
  "package": "package-name",
  "severity": "HIGH|MODERATE|LOW",
  "type": "Vulnerability type description",
  "description": "What the vulnerability is",
  "reason": "Why it's accepted in our context",
  "affected": ["package@version"],
  "critical": false,
  "riskLevel": "LOW|MEDIUM|HIGH",
  "exploitability": "Assessment of exploitability",
  "impact": "What could happen if exploited",
  "acceptedDate": "2026-01-29",
  "acceptedBy": "Your Name",
  "expiresDate": "2026-05-01",
  "fixVersion": "package@X.Y.Z",
  "fixEffort": "22-35 hours",
  "fixIsBreaking": true|false,
  "status": "ACCEPTED",
  "notes": "Any additional context",
  "remediation": "Steps to fix when exemption expires"
}
```

**Rules:**

- `expiresDate` MUST be before baseline.baselineExpiresAt
- `acceptedDate` SHOULD be today
- `fixEffort` MUST be realistic estimate
- `critical` MUST be true for HIGH severity or if exploitable
- All fields shown MUST be included

### Step 4: Run Sync Script

```bash
npm run sync:vulnerabilities
```

This regenerates `VULNERABILITY-ACCEPTANCE-LOG.md` with your changes.

### Step 5: Verify Generated Log

Check `.github/VULNERABILITY-ACCEPTANCE-LOG.md`:

- [ ] All new vulnerabilities appear
- [ ] Expiration dates are correct
- [ ] Severity levels are correct
- [ ] Days remaining calculated correctly
- [ ] Critical badges showing on critical items

### Step 6: Commit Both Files

```bash
git add .github/audit-baseline.json .github/VULNERABILITY-ACCEPTANCE-LOG.md
git commit -m "chore(security): Accept new vulnerabilities with time-bound exemptions

- Added GHSA-XXXX-XXXX-XXXX (package-name) expires 2026-05-01
- Reason: Vulnerability only affects build-time, not runtime
- Fix path: Upgrade to version X.Y.Z
- Synced vulnerability log from baseline"
```

---

## CI Integration

### Workflow Checks

**File:** `.github/workflows/security.yml`

The workflow must:

1. **Compare audit against baseline**

   ```bash
   npm audit --json > current-audit.json
   npm run sync:vulnerabilities  # Regenerate log
   ```

2. **Check for expired exemptions**

   ```bash
   # All exemptions must have expiresDate > today
   # Workflow fails if any exemption is expired
   ```

3. **Check for NEW vulnerabilities**

   ```bash
   # NEW vulnerabilities (not in baseline) cause CI failure
   # This prevents accepting vulnerabilities accidentally
   ```

4. **Allow KNOWN vulnerabilities**
   ```bash
   # Vulnerabilities in baseline are allowed
   # CI continues, no blocking
   ```

### Failing CI Conditions

CI fails and blocks merge if:

1. ‚ùå **NEW vulnerability detected** (not in audit-baseline.json)
   - Fix: Add to baseline with justification and expiration
   - OR upgrade to fix the vulnerability
   - OR remove the dependency

2. ‚ùå **Exemption is EXPIRED** (expiresDate <= today)
   - Fix: Must fix the underlying vulnerability
   - OR extend exemption if still justified (update expiresDate)

3. ‚ùå **Baseline is MALFORMED** (invalid JSON)
   - Fix: Correct JSON syntax in audit-baseline.json

### Passing CI Conditions

CI passes if:

1. ‚úÖ No new vulnerabilities (all in baseline)
2. ‚úÖ No expired exemptions (all expiresDate > today)
3. ‚úÖ Baseline is valid JSON
4. ‚úÖ All exemptions have required fields

---

## Expiration & Re-evaluation

### When Exemptions Expire

Exemptions become invalid if:

1. **Expiration date is reached**
   - Automatic CI failure
   - Blocks all CI/CD until resolved
   - No override possible

2. **Vulnerability is exploited in the wild**
   - Exemption immediately revoked
   - Emergency upgrade required
   - Priority: P0-CRITICAL

3. **Feature/dependency context changes**
   - Example: Dashboard moves to production
   - Exemption void
   - Must fix immediately

4. **Dependency is used in new context**
   - Example: Build-time dependency used at runtime
   - Exemption no longer valid
   - Must fix immediately

### Re-evaluation Schedule

**Quarterly Reviews (every 90 days):**

```bash
# Q1 Review Date: 2026-04-01
# Q2 Review Date: 2026-07-01
# Q3 Review Date: 2026-10-01
# Q4 Review Date: 2027-01-01
```

**During Reviews:**

1. Check if vulnerabilities are still valid
2. Assess if fixes are now available/feasible
3. Update expiresDate if needed
4. Plan remediation for approaching expirations
5. Run `npm run sync:vulnerabilities`
6. Commit updates

---

## Real-World Example

### Scenario: Accept a new vulnerability

**Step 1: npm audit shows new vulnerability**

```json
{
  "vulnerabilities": {
    "example-pkg": {
      "name": "example-pkg",
      "severity": "MODERATE",
      "direct": false,
      "resolution": {
        "type": "upgrade",
        "target": "2.0.0"
      }
}
```

**Step 2: Assess the vulnerability**

- Package: `example-pkg`
- Severity: MODERATE
- CVE: GHSA-1234-5678-9012
- Issue: Information disclosure in error messages
- Risk in our context: Low (only affects internal errors, logged only)
- Fix available: Yes, upgrade to 2.0.0
- Effort: 2-4 hours
- Breaking: Yes, new config required

**Step 3: Update audit-baseline.json**

Add entry:

```json
{
  "id": "example-pkg-info-disclosure",
  "cve": "GHSA-1234-5678-9012",
  "package": "example-pkg",
  "severity": "MODERATE",
  "type": "Information Disclosure in Error Messages",
  "description": "Package logs sensitive data in error messages when debug mode enabled",
  "reason": "Error messages are only logged internally to secure log files. No external exposure. Fix available but requires configuration changes.",
  "affected": ["example-pkg@1.5.0"],
  "critical": false,
  "riskLevel": "LOW",
  "exploitability": "MEDIUM (requires access to logs)",
  "impact": "Information disclosure of sensitive data in logs",
  "acceptedDate": "2026-01-29",
  "acceptedBy": "Your Name",
  "expiresDate": "2026-04-30",
  "fixVersion": "example-pkg@2.0.0",
  "fixEffort": "2-4 hours (config changes)",
  "fixIsBreaking": true,
  "status": "ACCEPTED",
  "notes": "Q1 remediation target - schedule for next sprint",
  "remediation": "Upgrade to 2.0.0 and update configuration per migration guide"
}
```

**Step 4: Sync**

```bash
npm run sync:vulnerabilities
```

Log now shows:

```
| GHSA-1234-5678-9012 | example-pkg | MODERATE | 2026-04-30 | 91 |  |
```

**Step 5: Commit**

```bash
git add .github/audit-baseline.json .github/VULNERABILITY-ACCEPTANCE-LOG.md
git commit -m "chore(security): Accept example-pkg info disclosure (expires 2026-04-30)

- CVE: GHSA-1234-5678-9012
- Severity: MODERATE
- Risk: LOW (internal logging only)
- Fix: Upgrade to example-pkg@2.0.0 (breaking, requires config)
- Target date: 2026-04-30 (Q1 remediation sprint)
- Synced vulnerability acceptance log"
```

---

## Important Dates (Current)

| Date       | Event                       | Action                                 |
| ---------- | --------------------------- | -------------------------------------- |
| 2026-03-31 | glob exemption expires      | Upgrade @next/eslint-plugin-next       |
| 2026-04-01 | Quarterly review            | Review all exemptions                  |
| 2026-05-01 | üî¥ CRITICAL: undici expires | MUST complete discord.js v15 migration |
| 2026-05-31 | tar exemptions expire       | Rebuild sqlite3                        |
| 2026-08-31 | Baseline expires            | Renew or revoke all exemptions         |

---

## Monitoring & Alerts

### Pre-commit Hook (Future)

When implemented, this will run before every commit:

```bash
npm run sync:vulnerabilities
# Check for expired exemptions
# Block commit if any are expired
```

### CI Workflow (Current)

Every PR/push runs security checks:

```bash
npm audit --json > audit.json
npm run sync:vulnerabilities
# Fail if: new vulnerabilities OR expired exemptions
```

### Manual Checks

```bash
# See vulnerability log
cat .github/VULNERABILITY-ACCEPTANCE-LOG.md

# Run audit to find new vulnerabilities
npm audit

# Compare against baseline
node .github/scripts/compare-audit-against-baseline.js
```

---

## Troubleshooting

### "VULNERABILITY-ACCEPTANCE-LOG.md is out of date"

**Solution:** Run sync script

```bash
npm run sync:vulnerabilities
git add .github/VULNERABILITY-ACCEPTANCE-LOG.md
git commit -m "chore: Regenerate vulnerability log"
```

### "CI failed: Expired exemption found"

**Solution:** Either fix the vulnerability or extend exemption

```json
// In audit-baseline.json
{
  "expiresDate": "2026-08-31" // Extend deadline
}
```

Then sync and commit:

```bash
npm run sync:vulnerabilities
git commit -m "chore: Extend exemption deadline for GHSA-..."
```

### "CI failed: New vulnerability not in baseline"

**Solution:** Add to baseline (see above section) or upgrade package

### "sync script failed to run"

**Solution:** Check JSON syntax in audit-baseline.json

```bash
node -e "console.log(JSON.parse(require('fs').readFileSync('.github/audit-baseline.json', 'utf8')))"
```

---

## Related Files

- [audit-baseline.json](.github/audit-baseline.json) - Source of truth
- [VULNERABILITY-ACCEPTANCE-LOG.md](.github/VULNERABILITY-ACCEPTANCE-LOG.md) - Generated log
- [VULNERABILITY-ACCEPTANCE-STRATEGY.md](.github/VULNERABILITY-ACCEPTANCE-STRATEGY.md) - Policy document
- [sync-vulnerability-baseline.js](../../scripts/sync-vulnerability-baseline.js) - Sync script
- [security.yml](.github/workflows/security.yml) - CI workflow

---

**Last Updated:** 2026-01-29
**Baseline Version:** 2.0.0
**Next Review:** 2026-04-01
**Critical Expiration:** 2026-05-01
